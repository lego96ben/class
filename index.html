<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iSchedule Pro - æš–æ©˜å®Œæ•´ç‰ˆ (å«é€šçŸ¥)</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --ios-orange: #FF9500;
            --warm-gradient: linear-gradient(135deg, #FF9D6C 0%, #BB4E75 100%);
            --glass: rgba(255, 255, 255, 0.25);
        }

        body {
            margin: 0; padding: 0;
            background: var(--warm-gradient);
            height: 100vh; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            display: flex; justify-content: center; overflow: hidden;
        }

        .phone-frame {
            width: 100%; max-width: 414px;
            background: var(--glass);
            backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
            border: 1px solid rgba(255,255,255,0.3);
            display: flex; flex-direction: column; position: relative;
        }

        /* é ‚éƒ¨æ¨™é¡Œèˆ‡åŠŸèƒ½æŒ‰éˆ•å€ */
        .header { padding: 45px 25px 10px; display: flex; justify-content: space-between; align-items: flex-start; }
        .header h1 { font-size: 30px; margin: 0; font-weight: 800; color: #fff; }
        
        .top-actions { display: flex; gap: 8px; }
        .action-btn { 
            background: white; color: var(--ios-orange); border: none; 
            padding: 8px 12px; border-radius: 12px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-size: 13px;
        }

        .live-date { font-size: 14px; color: rgba(255,255,255,0.9); margin-top: 5px; margin-left: 25px; font-weight: 500;}

        /* æ˜ŸæœŸåˆ‡æ›åˆ— */
        .week-nav {
            display: flex; justify-content: space-around;
            padding: 12px; margin: 10px 20px;
            background: rgba(255,255,255,0.2); border-radius: 18px;
        }
        .day-tab {
            width: 40px; height: 40px; display: flex; align-items: center;
            justify-content: center; border-radius: 14px; cursor: pointer;
            font-size: 14px; transition: 0.3s; color: white;
        }
        .day-tab.active { background: white; color: var(--ios-orange); font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.1);}

        /* æ™‚é–“è»¸èˆ‡èª²ç¨‹å¡ç‰‡ */
        .schedule-scroll { flex: 1; overflow-y: auto; padding: 10px 20px; }
        .time-row { display: flex; min-height: 100px; border-top: 0.5px solid rgba(255,255,255,0.2); }
        .time-label { width: 60px; font-size: 12px; color: rgba(255,255,255,0.8); margin-top: -8px; font-weight: bold; }

        .course-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 14px; border-radius: 16px;
            margin: 5px 0 15px 0; border-left: 6px solid;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            position: relative; cursor: pointer; transition: transform 0.2s;
        }
        .course-card:active { transform: scale(0.97); }
        .course-card h3 { margin: 0; font-size: 17px; color: #222; padding-right: 25px;}
        .course-card p { margin: 4px 0 0; font-size: 12px; color: #666; }

        .delete-btn { position: absolute; top: 12px; right: 12px; width: 24px; height: 24px; background: rgba(0,0,0,0.05); color: #999; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; border: none; }

        /* æ–°å¢æŒ‰éˆ• */
        .fab { position: absolute; bottom: 35px; right: 25px; width: 65px; height: 65px; background: white; border-radius: 50%; color: var(--ios-orange); font-size: 35px; border: none; box-shadow: 0 10px 20px rgba(0,0,0,0.2); cursor: pointer; }

        /* å½ˆçª—æ¨£å¼ */
        .modal { position: absolute; top: 100%; left: 0; width: 100%; height: 92%; background: #fff5f0; border-radius: 30px 30px 0 0; padding: 30px; box-sizing: border-box; transition: transform 0.4s ease; z-index: 100; }
        .modal.open { transform: translateY(-100%); }
        .form-item { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.02);}
        input, select { border: none; background: none; font-size: 16px; text-align: right; outline: none; color: #333; }
        input[type="color"] { width: 35px; height: 35px; padding: 0; cursor: pointer; border: none; border-radius: 8px;}
        .save-btn { width: 100%; padding: 18px; background: var(--ios-orange); color: white; border-radius: 18px; border: none; font-size: 18px; font-weight: 700; margin-top: 10px; cursor: pointer;}

        /* éš±è—çš„åŒ¯å‡ºå€ */
        #export-area { position: absolute; left: -9999px; top: 0; width: 1000px; padding: 40px; background: var(--warm-gradient); }
        .export-table { width: 100%; border-collapse: separate; border-spacing: 10px; background: rgba(255,255,255,0.25); backdrop-filter: blur(20px); border-radius: 20px; }
        .export-table th { color: white; padding: 15px; font-size: 20px; }
        .export-table td { background: white; border-radius: 12px; padding: 15px; vertical-align: top; width: 18%; min-height: 80px; }
    </style>
</head>
<body>

<div class="phone-frame">
    <div class="header">
        <h1>æˆ‘çš„èª²è¡¨</h1>
        <div class="top-actions">
            <button class="action-btn" onclick="testNotification()">ğŸ”” æ¸¬è©¦é€šçŸ¥</button>
            <button class="action-btn" onclick="exportToJPG()">åŒ¯å‡º JPG</button>
        </div>
    </div>
    <div class="live-date" id="liveDate">è¼‰å…¥ç³»çµ±æ™‚é–“...</div>

    <div class="week-nav">
        <div class="day-tab" data-day="1">ä¸€</div>
        <div class="day-tab" data-day="2">äºŒ</div>
        <div class="day-tab" data-day="3">ä¸‰</div>
        <div class="day-tab" data-day="4">å››</div>
        <div class="day-tab" data-day="5">äº”</div>
    </div>

    <div class="schedule-scroll" id="scheduleView"></div>

    <button class="fab" onclick="openModal()">+</button>

    <div class="modal" id="courseModal">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center;">
            <h2 id="modalTitle">æ–°å¢èª²ç¨‹</h2>
            <span onclick="closeModal()" style="color:var(--ios-orange); cursor:pointer; font-weight:bold; font-size: 17px;">å–æ¶ˆ</span>
        </div>
        <div class="form-item"><label>èª²ç¨‹åç¨±</label><input type="text" id="mName" placeholder="ä¾‹å¦‚ï¼šè¡Œå‹•ç¨‹å¼è¨­è¨ˆ"></div>
        <div class="form-item"><label>é¸æ“‡æ˜ŸæœŸ</label><select id="mDay"><option value="1">æ˜ŸæœŸä¸€</option><option value="2">æ˜ŸæœŸäºŒ</option><option value="3">æ˜ŸæœŸä¸‰</option><option value="4">æ˜ŸæœŸå››</option><option value="5">æ˜ŸæœŸäº”</option></select></div>
        <div class="form-item"><label>é–‹å§‹æ™‚é–“</label><input type="time" id="mStart" value="08:00"></div>
        <div class="form-item"><label>çµæŸæ™‚é–“</label><input type="time" id="mEnd" value="09:30"></div>
        <div class="form-item"><label>æå‰é€šçŸ¥</label><select id="mNotice"><option value="20">20 åˆ†é˜å‰</option><option value="10">10 åˆ†é˜å‰</option><option value="0">æº–æ™‚é€šçŸ¥</option></select></div>
        <div class="form-item"><label>é¡è‰²æ¨™ç±¤</label><input type="color" id="mColor" value="#FF9500"></div>
        <button class="save-btn" onclick="handleSave()">å„²å­˜è¨­å®š</button>
    </div>
</div>

<div id="export-area">
    <h1 style="color:white; text-align:center; font-size:40px; text-shadow: 0 4px 10px rgba(0,0,0,0.2);">é€±èª²è¡¨ç¸½è¦½</h1>
    <table class="export-table">
        <thead>
            <tr><th>æ™‚æ®µ</th><th>é€±ä¸€</th><th>é€±äºŒ</th><th>é€±ä¸‰</th><th>é€±å››</th><th>é€±äº”</th></tr>
        </thead>
        <tbody id="export-body"></tbody>
    </table>
</div>

<script>
    let activeDay = new Date().getDay() || 1;
    if (activeDay > 5) activeDay = 1;
    let allCourses = JSON.parse(localStorage.getItem('my_warm_timetable_v4')) || [];
    let editingId = null;

    function init() {
        const now = new Date();
        document.getElementById('liveDate').innerText = now.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
        
        document.querySelectorAll('.day-tab').forEach(tab => {
            if(parseInt(tab.dataset.day) === activeDay) tab.classList.add('active');
            tab.onclick = () => {
                document.querySelectorAll('.day-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                activeDay = parseInt(tab.dataset.day);
                renderSchedule();
            };
        });
        renderSchedule();
    }

    function renderSchedule() {
        const view = document.getElementById('scheduleView');
        view.innerHTML = "";
        const timeSlots = ["08:00", "09:00", "10:00", "11:00", "12:00", "13:00", "14:00", "15:00", "16:00", "17:00"];
        
        timeSlots.forEach(time => {
            const row = document.createElement('div');
            row.className = 'time-row';
            const h = time.split(':')[0];
            row.innerHTML = `<div class="time-label">${time}</div><div id="slot-${h}" style="flex:1"></div>`;
            view.appendChild(row);
        });

        allCourses.filter(c => parseInt(c.day) === activeDay).forEach(c => {
            const startH = c.start.split(':')[0];
            const target = document.getElementById(`slot-${startH}`);
            if(target) {
                const card = document.createElement('div');
                card.className = 'course-card';
                card.style.borderLeftColor = c.color;
                card.onclick = (e) => { if(e.target.className !== 'delete-btn') openEditModal(c); };
                card.innerHTML = `
                    <button class="delete-btn" onclick="deleteCourse(event, ${c.id})">âœ•</button>
                    <h3>${c.name}</h3>
                    <p>ğŸ•’ ${c.start} - ${c.end}</p>
                    <p>ğŸ”” æå‰ ${c.notice}m é€šçŸ¥</p>
                `;
                target.appendChild(card);
            }
        });
    }

    // Modal èˆ‡å„²å­˜é‚è¼¯
    function openModal() { editingId = null; document.getElementById('modalTitle').innerText="æ–°å¢èª²ç¨‹"; document.getElementById('mName').value=""; document.getElementById('courseModal').classList.add('open'); }
    function openEditModal(c) { editingId = c.id; document.getElementById('modalTitle').innerText="ç·¨è¼¯èª²ç¨‹"; document.getElementById('mName').value=c.name; document.getElementById('mDay').value=c.day; document.getElementById('mStart').value=c.start; document.getElementById('mEnd').value=c.end; document.getElementById('mNotice').value=c.notice; document.getElementById('mColor').value=c.color; document.getElementById('courseModal').classList.add('open'); }
    function closeModal() { document.getElementById('courseModal').classList.remove('open'); }

    function handleSave() {
        const name = document.getElementById('mName').value;
        const day = document.getElementById('mDay').value;
        const start = document.getElementById('mStart').value;
        const end = document.getElementById('mEnd').value;
        const notice = document.getElementById('mNotice').value;
        const color = document.getElementById('mColor').value;
        if(!name) return alert("è«‹è¼¸å…¥åç¨±");

        if(editingId) {
            allCourses = allCourses.map(c => c.id === editingId ? { ...c, name, day, start, end, notice, color } : c);
        } else {
            allCourses.push({ id: Date.now(), name, day, start, end, notice, color });
            
            // å¦‚æœè¨­å®šäº†é€šçŸ¥ï¼Œåœ¨æ§åˆ¶å°ç•™ä¸‹ç´€éŒ„ (æœªä¾†è½‰ APK å¯æ›¿æ›ç‚ºåŸç”Ÿä»£ç¢¼)
            if (notice > 0) console.log(`[ç³»çµ±æ’ç¨‹]: èª²ç¨‹ã€Œ${name}ã€å°‡åœ¨ ${start} çš„ ${notice} åˆ†é˜å‰ç™¼é€æ¨æ’­é€šçŸ¥ã€‚`);
        }
        localStorage.setItem('my_warm_timetable_v4', JSON.stringify(allCourses));
        closeModal(); renderSchedule();
    }

    function deleteCourse(e, id) {
        e.stopPropagation();
        if(confirm("ç¢ºå®šåˆªé™¤é€™é …å®‰æ’å—ï¼Ÿ")) {
            allCourses = allCourses.filter(c => c.id !== id);
            localStorage.setItem('my_warm_timetable_v4', JSON.stringify(allCourses));
            renderSchedule();
        }
    }

    // --- åŒ¯å‡º JPG åŠŸèƒ½ ---
    function exportToJPG() {
        const tbody = document.getElementById('export-body');
        tbody.innerHTML = "";
        const hours = ["08", "09", "10", "11", "12", "13", "14", "15", "16", "17"];

        hours.forEach(h => {
            let tr = "<tr>";
            tr += `<td style="font-weight:bold; text-align:center;">${h}:00</td>`;
            for(let d=1; d<=5; d++) {
                const course = allCourses.find(c => c.day == d && c.start.startsWith(h));
                if(course) {
                    tr += `<td style="border-top:6px solid ${course.color};"><strong>${course.name}</strong><br><small style="color:#666">${course.start} - ${course.end}</small></td>`;
                } else {
                    tr += `<td></td>`;
                }
            }
            tr += "</tr>";
            tbody.innerHTML += tr;
        });

        const exportArea = document.getElementById('export-area');
        html2canvas(exportArea, { scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'iSchedule_æœ¬é€±èª²è¡¨.jpg';
            link.href = canvas.toDataURL('image/jpeg', 0.9);
            link.click();
        });
    }

    // --- é€šçŸ¥æ¸¬è©¦åŠŸèƒ½ ---
    function testNotification() {
        if (!("Notification" in window)) {
            alert("æŠ±æ­‰ï¼Œä½ çš„ç€è¦½å™¨ä¸æ”¯æ´ç¶²é é€šçŸ¥æ¸¬è©¦ã€‚(iOS Safari éœ€å°‡ç¶²é åŠ å…¥ä¸»ç•«é¢æ‰èƒ½æ”¯æ´)");
            return;
        }

        // æª¢æŸ¥æ¬Šé™
        if (Notification.permission === "granted") {
            triggerRealNotification();
        } else if (Notification.permission !== "denied") {
            // è«‹æ±‚æ¬Šé™
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    triggerRealNotification();
                } else {
                    alert("ä½ æ‹’çµ•äº†é€šçŸ¥æ¬Šé™ï¼Œç„¡æ³•æ¸¬è©¦æ¨æ’­åŠŸèƒ½ã€‚");
                }
            });
        } else {
            alert("é€šçŸ¥æ¬Šé™å·²è¢«å°é–ï¼Œè«‹åˆ°ç€è¦½å™¨çš„ã€Œç¶²ç«™è¨­å®šã€ä¸­é–‹å•Ÿã€‚");
        }
    }

    function triggerRealNotification() {
        alert("âœ… é€šçŸ¥æ¬Šé™æ­£å¸¸ï¼\nç³»çµ±å°‡åœ¨ 3 ç§’å¾Œç™¼é€æ¨æ’­ï¼Œè«‹å°‡ç€è¦½å™¨ç¸®å°æˆ–åˆ‡æ›è‡³å…¶ä»–åˆ†é ä»¥æ¸¬è©¦æ•ˆæœã€‚");
        
        setTimeout(() => {
            const notif = new Notification("iSchedule èª²è¡¨æé†’", {
                body: "é€™æ˜¯ä¸€å‰‡æ¸¬è©¦é€šçŸ¥ï¼æœªä¾†ä½ çš„èª²ç¨‹å°‡æœƒåœ¨è¨­å®šçš„æ™‚é–“æº–æ™‚æé†’ä½  ğŸ””",
                icon: "https://cdn-icons-png.flaticon.com/512/3135/3135715.png" // æ¸¬è©¦ç”¨åœ–ç¤º
            });

            // é»æ“Šé€šçŸ¥æ™‚å›åˆ°ç¶²é 
            notif.onclick = function() {
                window.focus();
                this.close();
            };
        }, 3000);
    }

    init();
</script>

</body>
</html>
