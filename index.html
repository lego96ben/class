<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <script>
        // 1. è©¢å•é€šçŸ¥æ¬Šé™
        if ('Notification' in window) {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    console.log('é€šçŸ¥æ¬Šé™å·²å–å¾—ï¼');
                } else if (permission === 'denied') {
                    console.log('ä½¿ç”¨è€…æ‹’çµ•æ¥æ”¶é€šçŸ¥');
                }
            });
        }

        // 2. è¨»å†Š Service Worker (è®“æ‰‹æ©ŸçŸ¥é“ firebase-messaging-sw.js çš„å­˜åœ¨)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./firebase-messaging-sw.js')
                .then((reg) => {
                    console.log('Service Worker è¨»å†ŠæˆåŠŸ', reg);
                })
                .catch((err) => {
                    console.log('Service Worker è¨»å†Šå¤±æ•—', err);
                });
        }
    </script>
</body>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iSchedule Pro - æš–æ©˜ç·¨è¼¯ç‰ˆ</title>
    <style>
        :root {
            --ios-orange: #FF9500;
            --ios-red: #FF3B30;
            --warm-gradient: linear-gradient(135deg, #FF9D6C 0%, #BB4E75 100%);
            --glass: rgba(255, 255, 255, 0.25);
        }

        body {
            margin: 0; padding: 0;
            background: var(--warm-gradient);
            height: 100vh; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            display: flex; justify-content: center; overflow: hidden;
        }

        .phone-frame {
            width: 100%; max-width: 414px;
            background: var(--glass);
            backdrop-filter: blur(45px); -webkit-backdrop-filter: blur(45px);
            border: 1px solid rgba(255,255,255,0.3);
            display: flex; flex-direction: column; position: relative;
        }

        /* æ¨™é¡Œå€ */
        .header { padding: 50px 25px 15px; }
        .header h1 { font-size: 34px; margin: 0; font-weight: 800; color: #fff; text-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .live-date { font-size: 15px; color: rgba(255,255,255,0.9); margin-top: 5px; font-weight: 500; }

        .week-nav {
            display: flex; justify-content: space-around;
            padding: 12px; margin: 10px 20px;
            background: rgba(255,255,255,0.2); border-radius: 18px;
        }
        .day-tab {
            width: 40px; height: 40px; display: flex; align-items: center;
            justify-content: center; border-radius: 14px; cursor: pointer;
            font-size: 14px; transition: 0.3s; color: white;
        }
        .day-tab.active { background: white; color: var(--ios-orange); font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        /* èª²è¡¨å€åŸŸ */
        .schedule-scroll { flex: 1; overflow-y: auto; padding: 10px 20px; }
        .time-row { display: flex; min-height: 100px; border-top: 0.5px solid rgba(255,255,255,0.2); }
        .time-label { width: 60px; font-size: 12px; color: rgba(255,255,255,0.8); margin-top: -8px; font-weight: bold; }

        /* èª²ç¨‹å¡ç‰‡ */
        .course-card {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px; border-radius: 18px;
            margin: 5px 0 15px 0; border-left: 8px solid;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            position: relative; cursor: pointer;
            transition: transform 0.2s;
        }
        .course-card:active { transform: scale(0.97); }
        .course-card h3 { margin: 0; font-size: 18px; color: #333; }
        .course-card p { margin: 5px 0 0; font-size: 13px; color: #666; }

        /* åˆªé™¤æŒ‰éˆ• */
        .delete-btn {
            position: absolute; top: 12px; right: 12px;
            width: 24px; height: 24px; background: rgba(0,0,0,0.05);
            color: #999; border-radius: 50%; display: flex;
            align-items: center; justify-content: center;
            font-size: 14px; cursor: pointer; border: none;
        }

        /* æ©˜ç´…æ‡¸æµ®æŒ‰éˆ• */
        .fab {
            position: absolute; bottom: 35px; right: 25px;
            width: 65px; height: 65px; background: white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: var(--ios-orange); font-size: 35px; border: none; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.2); cursor: pointer;
        }

        /* ç·¨è¼¯/æ–°å¢ Modal */
        .modal {
            position: absolute; top: 100%; left: 0; width: 100%; height: 92%;
            background: #fff5f0; border-radius: 30px 30px 0 0;
            padding: 30px; box-sizing: border-box; transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            z-index: 100; box-shadow: 0 -10px 30px rgba(0,0,0,0.1);
        }
        .modal.open { transform: translateY(-100%); }

        .form-item {
            background: white; border-radius: 15px; padding: 15px;
            margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        input, select { border: none; background: none; font-size: 16px; text-align: right; outline: none; color: #333; }
        .save-btn {
            width: 100%; padding: 18px; background: var(--ios-orange);
            color: white; border-radius: 18px; border: none; font-size: 18px; font-weight: 700;
            margin-top: 10px; box-shadow: 0 5px 15px rgba(255,149,0,0.3);
        }
    </style>
</head>
<body>

<div class="phone-frame">
    <div class="header">
        <h1 id="titleDisplay">èª²è¡¨ä½ˆå±€</h1>
        <div class="live-date" id="liveDate">è¼‰å…¥ç³»çµ±æ™‚é–“...</div>
    </div>

    <div class="week-nav" id="weekNav">
        <div class="day-tab" data-day="1">ä¸€</div>
        <div class="day-tab" data-day="2">äºŒ</div>
        <div class="day-tab" data-day="3">ä¸‰</div>
        <div class="day-tab" data-day="4">å››</div>
        <div class="day-tab" data-day="5">äº”</div>
    </div>

    <div class="schedule-scroll" id="scheduleView"></div>

    <button class="fab" onclick="openModal()">+</button>

    <div class="modal" id="courseModal">
        <div style="display:flex; justify-content:space-between; margin-bottom:25px; align-items: center;">
            <h2 id="modalTitle" style="margin:0; color: #444;">æ–°å¢å®‰æ’</h2>
            <span onclick="closeModal()" style="color:var(--ios-orange); cursor:pointer; font-weight: bold; font-size: 17px;">å®Œæˆ</span>
        </div>

        <div class="form-item">
            <label>èª²ç¨‹åç¨±</label>
            <input type="text" id="mName" placeholder="ä¾‹å¦‚ï¼šè¡Œå‹•ç¨‹å¼é–‹ç™¼">
        </div>
        <div class="form-item">
            <label>é¸æ“‡æ˜ŸæœŸ</label>
            <select id="mDay">
                <option value="1">æ˜ŸæœŸä¸€</option>
                <option value="2">æ˜ŸæœŸäºŒ</option>
                <option value="3">æ˜ŸæœŸä¸‰</option>
                <option value="4">æ˜ŸæœŸå››</option>
                <option value="5">æ˜ŸæœŸäº”</option>
            </select>
        </div>
        <div class="form-item">
            <label>ä¸Šèª²æ™‚é–“</label>
            <input type="time" id="mStart" value="08:00">
        </div>
        <div class="form-item">
            <label>ä¸‹èª²æ™‚é–“</label>
            <input type="time" id="mEnd" value="09:30">
        </div>
        <div class="form-item">
            <label>æå‰é€šçŸ¥</label>
            <select id="mNotice">
                <option value="20">20 åˆ†é˜å‰</option>
                <option value="10">10 åˆ†é˜å‰</option>
                <option value="0">æº–æ™‚é€šçŸ¥</option>
            </select>
        </div>
        <div class="form-item">
            <label>å°ˆå±¬é¡è‰²</label>
            <input type="color" id="mColor" value="#FF9500">
        </div>

        <button class="save-btn" id="saveActionBtn" onclick="handleSave()">å„²å­˜è¨­å®š</button>
    </div>
</div>

<script>
    let activeDay = new Date().getDay(); 
    if (activeDay === 0 || activeDay === 6) activeDay = 1;

    let allCourses = JSON.parse(localStorage.getItem('my_warm_timetable')) || [];
    let editingId = null; // ç´€éŒ„ç›®å‰æ­£åœ¨ç·¨è¼¯çš„ ID

    function init() {
        const now = new Date();
        const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
        document.getElementById('liveDate').innerText = now.toLocaleDateString('zh-TW', options);
        
        document.querySelectorAll('.day-tab').forEach(tab => {
            if(parseInt(tab.dataset.day) === activeDay) tab.classList.add('active');
            tab.onclick = () => {
                document.querySelectorAll('.day-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                activeDay = parseInt(tab.dataset.day);
                renderSchedule();
            };
        });
        renderSchedule();
    }

    function renderSchedule() {
        const view = document.getElementById('scheduleView');
        view.innerHTML = "";
        const timeSlots = ["08:00", "09:00", "10:00", "11:00", "12:00", "13:00", "14:00", "15:00", "16:00", "17:00"];

        timeSlots.forEach(time => {
            const row = document.createElement('div');
            row.className = 'time-row';
            const h = time.split(':')[0];
            row.innerHTML = `<div class="time-label">${time}</div><div id="slot-${h}" style="flex:1"></div>`;
            view.appendChild(row);
        });

        allCourses.filter(c => parseInt(c.day) === activeDay).forEach(c => {
            const startH = c.start.split(':')[0];
            const target = document.getElementById(`slot-${startH}`);
            if(target) {
                const card = document.createElement('div');
                card.className = 'course-card';
                card.style.borderLeftColor = c.color;
                card.onclick = (e) => { if(e.target.className !== 'delete-btn') openEditModal(c); };
                card.innerHTML = `
                    <button class="delete-btn" onclick="deleteCourse(event, ${c.id})">âœ•</button>
                    <h3>${c.name}</h3>
                    <p>ğŸ•’ ${c.start} - ${c.end}</p>
                    <p>ğŸ”” æå‰ ${c.notice}m é€šçŸ¥</p>
                `;
                target.appendChild(card);
            }
        });
    }

    function openModal() {
        editingId = null;
        document.getElementById('modalTitle').innerText = "æ–°å¢èª²ç¨‹";
        document.getElementById('mName').value = "";
        document.getElementById('courseModal').classList.add('open');
    }

    function openEditModal(course) {
        editingId = course.id;
        document.getElementById('modalTitle').innerText = "ç·¨è¼¯èª²ç¨‹";
        document.getElementById('mName').value = course.name;
        document.getElementById('mDay').value = course.day;
        document.getElementById('mStart').value = course.start;
        document.getElementById('mEnd').value = course.end;
        document.getElementById('mNotice').value = course.notice;
        document.getElementById('mColor').value = course.color;
        document.getElementById('courseModal').classList.add('open');
    }

    function closeModal() { document.getElementById('courseModal').classList.remove('open'); }

    function handleSave() {
        const name = document.getElementById('mName').value;
        const day = document.getElementById('mDay').value;
        const start = document.getElementById('mStart').value;
        const end = document.getElementById('mEnd').value;
        const notice = document.getElementById('mNotice').value;
        const color = document.getElementById('mColor').value;

        if(!name) return alert("è«‹è¼¸å…¥åç¨±");

        if(editingId) {
            // ç·¨è¼¯é‚è¼¯ï¼šæ‰¾åˆ°èˆŠçš„ä¸¦æ›¿æ›
            allCourses = allCourses.map(c => c.id === editingId ? { ...c, name, day, start, end, notice, color } : c);
        } else {
            // æ–°å¢é‚è¼¯
            allCourses.push({ id: Date.now(), name, day, start, end, notice, color });
        }

        localStorage.setItem('my_warm_timetable', JSON.stringify(allCourses));
        closeModal();
        renderSchedule();
    }

    function deleteCourse(e, id) {
        e.stopPropagation(); // é˜²æ­¢è§¸ç™¼ç·¨è¼¯å½ˆçª—
        if(confirm("ç¢ºå®šç§»é™¤é€™é …å®‰æ’å—ï¼Ÿ")) {
            allCourses = allCourses.filter(c => c.id !== id);
            localStorage.setItem('my_warm_timetable', JSON.stringify(allCourses));
            renderSchedule();
        }
    }

    init();
</script>

</body>

</html>
